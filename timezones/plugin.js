(()=>{var k=Object.create;var f=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var K=Object.getOwnPropertyNames;var Z=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var J=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),V=(e,t)=>{for(var o in t)f(e,o,{get:t[o],enumerable:!0})},z=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of K(t))!q.call(e,s)&&s!==o&&f(e,s,{get:()=>t[s],enumerable:!(n=H(t,s))||n.enumerable});return e};var T=(e,t,o)=>(o=e!=null?k(Z(e)):{},z(t||!e||!e.__esModule?f(o,"default",{value:e,enumerable:!0}):o,e)),Q=e=>z(f({},"__esModule",{value:!0}),e);var c=J((Me,_)=>{_.exports=shelter.solidWeb});var Ae={};V(Ae,{onUnload:()=>ge,settings:()=>G});var O=T(c()),F=T(c());var w={[-9]:["AKST"],[-8]:["PST"],[-7]:["MST"],[-6]:["CT","CST"],[-5]:["ET","EST"],[-4]:["EDT"],[-3]:["AMST","ART","BRT","SRT","UYT","WGT"],[-2]:["FNT","PMDT"],[-1]:["AZOT","CVT","EGT"],0:["UTC","GMT","WET"],1:["CET","MET","WAT"],2:["CAT","EET","KALT","SAST","WAST"],3:["AST","EAT","FET","IOT","MSK","TRT"],4:["RET","AMT"],5:["MVT","PKT","TJT","TMT","UZT"],5.5:["IST"],7:["THA","WIB"],8:["AWST","CST","HKT","MST","MYT","SGT","WST"],9:["JST","KST"],9.5:["ACST"],10:["AEST","AET","VLAT"],12:["NZST"]},X=Object.values(w).flat(),ee=Object.fromEntries(Object.entries(w).flatMap(([e,t])=>t.map(o=>[o,parseFloat(e)]))),te=new RegExp(`(?<![a-zA-Z0-9])(${X.join("|")})(?:([+-]\\d+)(?::(\\d+))?)?\b`),d=e=>{if(!e)return;let t=e.match(te);if(!t)return;let[,o,n,s]=t;return ee[o]+parseFloat(n??0)+parseFloat(s??0)/60};var oe="https://timezonedb.catvibers.me/api/user/bulk",ne="shelter/0.0.0 timestamptools/1.0.0",E=new Map,g=!1,se=150,h=new Map,re=()=>setTimeout(async()=>{let e=E;E=new Map;let t=JSON.stringify([...e.keys()]);try{let o=await fetch(oe,{method:"post",body:t,headers:{"X-User-Agent":ne,"Content-Type":"application/json"}}).then(n=>n.json());for(let n in o)if(e.has(n)&&o[n]){let s=parseFloat(o[n].timezone);e.get(n)?.(s),h.set(n,s)}for(let[n,s]of e.entries())s(),h.set(n,void 0)}finally{g=!1}},se),y=e=>h.has(e)?h.get(e):new Promise(t=>{setTimeout(t,3e3),E.set(e,t),g||(g=!0,re())});var{flux:{dispatcher:N},util:{getFiber:A,reactFiberWalker:C},ui:{injectCss:ie},observeDom:ae}=shelter,x=new Set,P=new Set,p=new Map;async function D(e,t){if(x.has(t))return;let o=C(A(e),s=>s.stateNode?.handlePreload,!0)?.stateNode;if(!o)return;let n=o.handlePreload();return x.add(t),n}var ce=(e,t)=>new Promise(o=>{let n=C(A(e),"onMouseDown");if(!n?.memoizedProps?.onClick)return o();let s=ie("[class^=layerContainer-]{display:none}");n.memoizedProps.onClick(new MouseEvent(""));let a=!1,m=ae("[class^=userPopoutOuter]",u=>{if(a)return;C(A(u),"user")?.memoizedProps?.user?.id===t&&(a=!0,m(),o(),requestAnimationFrame(()=>{n.memoizedProps.onClick(new MouseEvent("")),requestAnimationFrame(s)}))});setTimeout(m,250),setTimeout(s,250)}),le=()=>new Promise(async e=>{let t=()=>{e(),N.unsubscribe("USER_NOTE_LOADED",t)};N.subscribe("USER_NOTE_LOADED",t),setTimeout(t,1e3)}),U=async(e,t)=>{if(!P.has(t))if(p.has(t))await p.get(t);else{let o=ce(e,t).then(le);p.set(t,o),await o,p.delete(t),P.add(t)}};var me=(0,O.template)('<time class="ys_tz"> (Theirs: <!>)</time>',3),{plugin:{store:ue},flux:{stores:S}}=shelter,fe=(e,t)=>d(S.UserProfileStore.getUserProfile(e)?.bio)??d(S.UserProfileStore.getGuildMemberProfile(e,t)?.bio)??d(S.NoteStore.getNote(e)?.note),M=new Set,j=e=>!e.parentElement.querySelector(".ys_tz")&&!M.has(e);async function Te(e,t){if(ue.tzdb){let o=await y(t.author.id);if(o!==void 0)return o}return await Promise.all([D(e.parentElement.parentElement.querySelector("[id^=message-username]").firstElementChild,t.author.id),U(e.parentElement.parentElement.querySelector("[id^=message-username]"),t.author.id)]),fe(t.author.id,S.ChannelStore.getChannel(t.channel_id)?.guild_id)}async function v(e,t,o){M.add(t);let n=await Te(t,e);M.delete(t),!(!n||(o.utc(),o.hours(o.hours()+n),Date.now()-Date.parse(o.toISOString())>1e3*60*60*24))&&t.parentElement.append((()=>{let a=me.cloneNode(!0),m=a.firstChild,u=m.nextSibling,Y=u.nextSibling;return(0,F.insert)(a,()=>o.format("HH:mm"),u),a})())}var{plugin:{store:de}}=shelter,I=e=>e.dataset.abstime!==e.childNodes[1].textContent;function R(e,t){de.absUtc&&t.utc();let o=t.format("YYYY-MM-DD hh:mm:ss");e.dataset.abstime=o,e.childNodes[1].textContent=o}var B=T(c()),l=T(c()),he=(0,B.template)('<a href="https://timezonedb.catvibers.me/?client_mod=shelter" target="_blank">TZDB</a>',2),{plugin:{store:r},ui:{SwitchItem:b}}=shelter,G=()=>[(0,l.createComponent)(b,{get value(){return r.tz},onChange:e=>r.tz=e,children:"Show users' local time (parses timezones from bios & notes)"}),(0,l.createComponent)(b,{get disabled(){return!r.tz},get value(){return r.tzdb},onChange:e=>r.tzdb=e,get children(){return["Prefer to query"," ",he.cloneNode(!0)]}}),(0,l.createComponent)(b,{get value(){return r.abs},onChange:e=>r.abs=e,children:"Show times in absolute ISO form (YYYY-MM-DD HH:MM:SS) every time, instead of relative times"}),(0,l.createComponent)(b,{get disabled(){return!r.abs},get value(){return r.absUtc},onChange:e=>r.absUtc=e,children:"Show absolute times in UTC, not local timezone"})];var{plugin:{store:i},flux:{dispatcher:$},observeDom:pe,util:{getFiber:Se,reactFiberWalker:be}}=shelter;i.tz??=!0;i.tzdb??=!0;i.abs??=!1;i.absUtc??=!1;async function Ee(e){let t=i.tz&&j(e),o=i.abs&&I(e);if(!t&&!o)return;let n=be(Se(e),"message",!0)?.memoizedProps?.message,s=n?.timestamp;!s||(o&&R(e,s.clone()),t&&await v(n,e,s.clone()))}function L(){if(!i.tz&&!i.abs)return;let e=pe("h3 time[id^=message-timestamp]",t=>{e(),Ee(t)});setTimeout(e,500)}var W=["MESSAGE_CREATE","CHANNEL_SELECT","LOAD_MESSAGES_SUCCESS","UPDATE_CHANNEL_DIMENSIONS","MESSAGE_END_EDIT","MESSAGE_UPDATE"];W.forEach(e=>$.subscribe(e,L));var ge=()=>W.forEach(e=>$.unsubscribe(e,L));return Q(Ae);})();
