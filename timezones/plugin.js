(()=>{var te=Object.create;var h=Object.defineProperty;var re=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var oe=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty;var ie=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),ae=(e,t)=>{for(var r in t)h(e,r,{get:t[r],enumerable:!0})},w=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of ne(t))!se.call(e,o)&&o!==r&&h(e,o,{get:()=>t[o],enumerable:!(n=re(t,o))||n.enumerable});return e};var m=(e,t,r)=>(r=e!=null?te(oe(e)):{},w(t||!e||!e.__esModule?h(r,"default",{value:e,enumerable:!0}):r,e)),le=e=>w(h({},"__esModule",{value:!0}),e);var l=ie((ke,N)=>{N.exports=shelter.solidWeb});var Oe={};ae(Oe,{onUnload:()=>Fe,settings:()=>J});var j=m(l()),B=m(l());var $={[-9]:["AKST"],[-8]:["PST"],[-7]:["MST"],[-6]:["CT","CST"],[-5]:["ET","EST"],[-4]:["EDT"],[-3]:["AMST","ART","BRT","SRT","UYT","WGT"],[-2]:["FNT","PMDT"],[-1]:["AZOT","CVT","EGT"],0:["UTC","GMT","WET"],1:["CET","MET","WAT"],2:["CAT","EET","KALT","SAST","WAST"],3:["AST","EAT","FET","IOT","MSK","TRT"],4:["RET","AMT"],5:["MVT","PKT","TJT","TMT","UZT"],5.5:["IST"],7:["THA","WIB"],8:["AWST","CST","HKT","MST","MYT","SGT","WST"],9:["JST","KST"],9.5:["ACST"],10:["AEST","AET","VLAT"],12:["NZST"]},C=Object.values($).flat(),ce=Object.fromEntries(Object.entries($).flatMap(([e,t])=>t.map(r=>[r,parseFloat(e)]))),ue=new RegExp(`(?<![a-zA-Z0-9])(${C.join("|")})(?:([+-]\\d+)(?::(\\d+))?)?\\b`),g=e=>{if(!e)return;let t=e.match(ue);if(!t)return;let[,r,n,o]=t;return ce[r]+parseFloat(n??0)+parseFloat(o??0)/60};var me="https://timezonedb.catvibers.me/api/user/bulk",de="shelter/0.0.0 timestamptools/1.0.0",_=new Map,M=!1,Te=150,S=new Map,fe=()=>setTimeout(async()=>{let e=_;_=new Map;let t=JSON.stringify([...e.keys()]);try{let r=await fetch(me,{method:"post",body:t,headers:{"X-User-Agent":de,"Content-Type":"application/json"}}).then(n=>n.json());for(let n in r)if(e.has(n)&&r[n]){let o=parseFloat(r[n].timezone);e.get(n)?.(o),S.set(n,o)}for(let[n,o]of e.entries())o(),S.set(n,void 0)}finally{M=!1}},Te),D=e=>S.has(e)?S.get(e):new Promise(t=>{setTimeout(t,3e3),_.set(e,t),M||(M=!0,fe())});var pe=(0,j.template)('<time class="ys_tz"> (Theirs: <!>)</time>',3),{plugin:{store:F},flux:{stores:v},util:{getFiber:he,reactFiberWalker:ge}}=shelter,I=new Set;async function Se(e,t){if(I.has(t))return;let r=ge(he(e),o=>o.stateNode?.handlePreload,!0)?.stateNode;if(!r)return;let n=r.handlePreload();return I.add(t),n}var be=e=>(isNaN(parseFloat(e))?void 0:parseFloat(e))??g(e),Ee=(e,t)=>be(F.savedTzs[e])??g(v.UserProfileStore.getUserProfile(e)?.bio)??g(v.UserProfileStore.getGuildMemberProfile(e,t)?.bio),y=new Set,O=e=>!e.parentElement.querySelector(".ys_tz")&&!y.has(e);async function ze(e,t){if(F.tzdb){let r=await D(t.author.id);if(r!==void 0)return r}return await Se(e.parentElement.parentElement.querySelector("[id^=message-username]").firstElementChild,t.author.id),Ee(t.author.id,v.ChannelStore.getChannel(t.channel_id)?.guild_id)}async function P(e,t,r){y.add(t);let n=await ze(t,e);y.delete(t),!(n===void 0||n*60===r.utcOffset())&&(r.utc(),r.hours(r.hours()+n),t.parentElement.append((()=>{let o=pe.cloneNode(!0),z=o.firstChild,p=z.nextSibling,s=p.nextSibling;return(0,B.insert)(o,()=>r.format("HH:mm"),p),o})()))}var{plugin:{store:Ae}}=shelter,k=e=>e.dataset.abstime!==e.childNodes[1].textContent;function H(e,t){Ae.absUtc&&t.utc();let r=t.format("YYYY-MM-DD hh:mm:ss");e.dataset.abstime=r,e.childNodes[1].textContent=r}var Y=m(l()),T=m(l()),Ce=(0,Y.template)('<a href="https://timezonedb.catvibers.me/?client_mod=shelter" target="_blank">TZDB</a>',2),{plugin:{store:i},ui:{SwitchItem:b,Button:_e}}=shelter,G=e=>[(0,T.createComponent)(b,{get value(){return i.tz},onChange:t=>i.tz=t,children:"Show users' local time (parses timezones from bios)"}),(0,T.createComponent)(b,{get disabled(){return!i.tz},get value(){return i.tzdb},onChange:t=>i.tzdb=t,get children(){return["Prefer to query"," ",Ce.cloneNode(!0)]}}),(0,T.createComponent)(b,{get value(){return i.abs},onChange:t=>i.abs=t,children:"Show times in absolute ISO form (YYYY-MM-DD HH:MM:SS) every time, instead of relative times"}),(0,T.createComponent)(b,{get disabled(){return!i.abs},get value(){return i.absUtc},onChange:t=>i.absUtc=t,children:"Show absolute times in UTC, not local timezone"}),(0,T.createComponent)(_e,{onClick:()=>e(1),grow:!0,children:"Manage manual user TZs"})];var E=m(l()),Ke=m(l()),c=m(l()),a=m(l());var Me=(0,E.template)('<div style="display: grid; grid-template-columns: 1fr 1fr auto; margin-top: 1rem"><div></div></div>',4),ve=(0,E.template)('<div style="display: flex; margin: .5rem 0"></div>',2),Z=(0,E.template)("<div></div>",2),{flux:{stores:ye},plugin:{store:d},ui:{Button:x,ButtonLooks:xe,ButtonSizes:Ue,Header:L,HeaderTags:R,TextBox:W,Text:we,Divider:Ne},solid:{createSignal:K}}=shelter,q=e=>{let[t,r]=K(""),[n,o]=K(""),z=s=>{delete d.savedTzs[s],d.savedTzs={...d.savedTzs}},p=()=>{if(t()in d.savedTzs||t().length!==18||t().match(/\D/))return;let s=C.includes(n())?n():Number.isFinite(parseFloat(n()))?parseFloat(n()):void 0;s!==void 0&&(d.savedTzs={...d.savedTzs,[t()]:s},r(""),o(""))};return[(0,a.createComponent)(x,{onClick:()=>e(0),grow:!0,children:"Back to settings"}),(()=>{let s=Me.cloneNode(!0),U=s.firstChild;return(0,c.insert)(s,(0,a.createComponent)(L,{get tag(){return R.H4},children:"User"}),U),(0,c.insert)(s,(0,a.createComponent)(L,{get tag(){return R.H4},children:"TZ or UTC offset"}),U),(0,c.insert)(s,()=>Object.entries(d.savedTzs).map(([A,ee])=>[(()=>{let f=Z.cloneNode(!0);return(0,c.insert)(f,()=>ye.UserStore.getUser(A)?.tag??A),f})(),(()=>{let f=Z.cloneNode(!0);return(0,c.insert)(f,ee),f})(),(0,a.createComponent)(x,{get look(){return xe.OUTLINED},get size(){return Ue.TINY},grow:!0,onClick:()=>z(A),children:"Delete"})]),null),s})(),(0,a.createComponent)(Ne,{mt:!0}),(()=>{let s=ve.cloneNode(!0);return(0,c.insert)(s,(0,a.createComponent)(W,{get value(){return t()},onInput:r,placeholder:"User ID"}),null),(0,c.insert)(s,(0,a.createComponent)(W,{get value(){return n()},onInput:o,placeholder:"TZ or offset"}),null),(0,c.insert)(s,(0,a.createComponent)(x,{grow:!0,style:{height:"auto"},onClick:p,children:"Add"}),null),s})(),(0,a.createComponent)(we,{children:"You must enter a valid user ID, and either a numeric offset from UTC or a recognised TZ."})]};var $e=[G,q],J=()=>{let[e,t]=shelter.solid.createSignal(0);return shelter.solid.createMemo(()=>$e[e()](t))};var{plugin:{store:u},flux:{dispatcher:V},observeDom:De,util:{getFiber:Ie,reactFiberWalker:je}}=shelter;u.tz??=!0;u.tzdb??=!0;u.abs??=!1;u.absUtc??=!1;u.savedTzs??={};async function Be(e){let t=u.tz&&O(e),r=u.abs&&k(e);if(!t&&!r)return;let n=je(Ie(e),"message",!0)?.memoizedProps?.message,o=n?.timestamp;!o||(r&&H(e,o.clone()),t&&await P(n,e,o.clone()))}function Q(){if(!u.tz&&!u.abs)return;let e=De("h3 time[id^=message-timestamp]",t=>{e(),Be(t)});setTimeout(e,500)}var X=["MESSAGE_CREATE","CHANNEL_SELECT","LOAD_MESSAGES_SUCCESS","UPDATE_CHANNEL_DIMENSIONS","MESSAGE_END_EDIT","MESSAGE_UPDATE"];X.forEach(e=>V.subscribe(e,Q));var Fe=()=>X.forEach(e=>V.unsubscribe(e,Q));return le(Oe);})();
