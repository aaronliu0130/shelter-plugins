(()=>{var N=Object.create;var c=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var v=Object.getPrototypeOf,w=Object.prototype.hasOwnProperty;var U=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),k=(e,t)=>{for(var r in t)c(e,r,{get:t[r],enumerable:!0})},T=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of P(t))!w.call(e,i)&&i!==r&&c(e,i,{get:()=>t[i],enumerable:!(o=D(t,i))||o.enumerable});return e};var _=(e,t,r)=>(r=e!=null?N(v(e)):{},T(t||!e||!e.__esModule?c(r,"default",{value:e,enumerable:!0}):r,e)),C=e=>T(c({},"__esModule",{value:!0}),e);var g=U((J,S)=>{S.exports=shelter.solidWeb});var K={};k(K,{onUnload:()=>B,settings:()=>H});var u="Music";var d="1107251687984472144",b="311958e99f6ee58518756f83720db787";var A=["2a96cbd8b46e442fc41c2b86b821562f","c6f59c1e5e7240a4c0d427abd71f3dbb"];var Q=_(g(),1),n=_(g(),1);var{store:a}=shelter.plugin,{TextBox:f,SwitchItem:x,Header:h,HeaderTags:I,Divider:F,Text:R,LinkButton:V,Space:E}=shelter.ui,H=()=>[(0,n.createComponent)(h,{get tag(){return I.H3},children:"Application Name"}),(0,n.createComponent)(f,{placeholder:u,get value(){return a.appName??""},onInput:e=>a.appName=e}),(0,n.createComponent)(h,{get tag(){return I.H3},children:"Last.fm username (required)"}),(0,n.createComponent)(f,{get value(){return a.user??""},onInput:e=>a.user=e}),(0,n.createComponent)(h,{get tag(){return I.H3},children:"Update interval (seconds)"}),(0,n.createComponent)(f,{placeholder:5e3/1e3+"",get value(){return a.interval?a.interval/1e3+"":""},onInput:e=>(!e||!isNaN(parseFloat(e)))&&(a.interval=e?parseFloat(e)*1e3||5e3:void 0)}),(0,n.createComponent)(F,{mt:!0,mb:!0}),(0,n.createComponent)(x,{get value(){return a.stamp},onChange:e=>a.stamp=e,note:"Show time since song started playing",children:"Show time elapsed"}),(0,n.createComponent)(x,{get value(){return a.ignoreSpotify},onChange:e=>a.ignoreSpotify=e,note:"Hide the status if Spotify is playing",children:"Hide when using Spotify"}),(0,n.createComponent)(R,{get children(){return["Thanks to",(0,n.createComponent)(V,{href:"https://github.com/amsyarasyiq/letup/blob/main/plugins/Last.fm",get children(){return[(0,n.createComponent)(E,{}),"Pylix's Vendetta plugin",(0,n.createComponent)(E,{})]}}),"for useful implementation details and reference."]}})];var{plugin:{store:s},flux:{storesFlat:L,dispatcher:Y}}=shelter;s.stamp??=!0;s.ignoreSpotify??=!0;var M=L.UserStore,$=L.PresenceStore,l=(e="",t)=>{Y.dispatch({type:"LOCAL_ACTIVITY_UPDATE",activity:t?{name:e,flags:1,type:2,details:t.name,state:`by ${t.artist}`,application_id:d,timestamps:s.stamp?{start:~~(Date.now()/1e3)}:void 0,assets:{large_text:t.album&&`on ${t.album}`}}:null,socketId:"Last.fm@shelter"})},G=async()=>{let e=new URLSearchParams({method:"user.getrecenttracks",user:s.user,api_key:b,format:"json",limit:"1",extended:"1"}),t=await fetch(`https://ws.audioscrobbler.com/2.0/?${e}`);if(!t.ok)return;let r=(await t.json())?.recenttracks?.track?.[0];if(!r)return;let o=r.image[3]["#text"];return{name:r.name,artist:r.artist.name,album:r.album["#text"],albumArt:A.includes(o)?void 0:o,url:r.url,date:r.date?.["#text"]??"now",nowPlaying:!!r["@attr"]?.nowplaying,loved:r.loved==="1"}},y,j=async()=>{if(!s.user)return l();if(s.ignoreSpotify){for(let r of $.getActivities(M.getCurrentUser().id))if(r?.type===2&&r.application_id!==d)return l()}let e=await G();if(!e?.nowPlaying)return l();if(e.url===y)return;y=e.url;let t=s.appName||u;for(let r in e)t=t.replaceAll(`{{${r}}}`,e[r]);l(t,e)},m,q=()=>(m&&clearInterval(m),m=setInterval(j,s.interval||5e3));q();var B=()=>(clearInterval(m),l());return C(K);})();
