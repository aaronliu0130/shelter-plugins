(()=>{var Z=Object.create;var A=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var re=Object.getPrototypeOf,ne=Object.prototype.hasOwnProperty;var se=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),oe=(t,e)=>{for(var r in e)A(t,r,{get:e[r],enumerable:!0})},C=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of te(e))!ne.call(t,a)&&a!==r&&A(t,a,{get:()=>e[a],enumerable:!(s=ee(e,a))||s.enumerable});return t};var N=(t,e,r)=>(r=t!=null?Z(re(t)):{},C(e||!t||!t.__esModule?A(r,"default",{value:t,enumerable:!0}):r,t)),ae=t=>C(A({},"__esModule",{value:!0}),t);var g=se((rt,V)=>{V.exports=shelter.solidWeb});var Te={};oe(Te,{onUnload:()=>ke,settings:()=>we});var D="{{name}}";var h="1107251687984472144",v="311958e99f6ee58518756f83720db787";var L=["2a96cbd8b46e442fc41c2b86b821562f","c6f59c1e5e7240a4c0d427abd71f3dbb"];var x=t=>{if(t??=Object.keys(window).find(r=>r.startsWith("webpackChunk")),!window[t])return;let e;return window[t].push([[Symbol()],{},r=>{e=r}]),window[t].pop(),[e.c??Object.fromEntries(Object.entries(e.m).map(([r])=>[r,{id:r,loaded:!0,exports:e(r)}])),e]};var d=t=>e=>t.every(r=>e[r]!==void 0),c=t=>e=>e.prototype&&t.every(r=>e.prototype[r]!==void 0),u=(t,e=!0)=>r=>(e?r.displayName:r.default?.displayName)===t,f=t=>e=>t.every(r=>Object.keys(e).some(s=>s.toLowerCase().includes(r.toLowerCase()))),m=t=>e=>{let r=new RegExp(`(${t}$)|((\\w+\\()+${t}\\))`);if(r.test(e.displayName))return!0;if(typeof e.$$typeof=="symbol"&&e.Consumer===void 0&&(e.type||e.render)){for(;typeof e.type=="object"||typeof e.render=="object";)e=e.type??e.render;if(r.test(e.type?.displayName)||r.test(e.render?.displayName))return!0}},F=t=>typeof t=="object"||typeof t=="function",y=t=>e=>F(e)&&Object.values(e).some(r=>F(r)&&t.some(s=>r?.[s]!==void 0)),R=(t,e)=>r=>Object.entries(e).filter(([,s])=>s.toString().match(r)).map(([s])=>t[s]?.exports).filter(s=>s);var de=(t,e)=>{let r=[],s=a=>e.forEach(([n,p],b)=>{p&&!r[b]&&(r[b]=[]),n(a)&&(p?r[b].push(a):r[b]||(r[b]=a))});for(let a in t){let n=t[a].exports;!n||n===window||(n.default&&n.__esModule&&s(n.default),s(n))}return r},ce=t=>({find:e=>t.push([e,!1]),findAll:e=>t.push([e,!0]),findByProps:(...e)=>t.push([d(e),!1]),findByPropsAll:(...e)=>t.push([d(e),!0]),findByPrototypes:(...e)=>t.push([c(e),!1]),findByPrototypesAll:(...e)=>t.push([c(e),!0]),findByNestedProps:(...e)=>t.push([y(e),!1]),findByNestedPropsAll:(...e)=>t.push([y(e),!0]),findByDisplayName:(e,r)=>t.push([u(e,r),!1]),findByDisplayNameAll:(e,r)=>t.push([u(e,r),!0]),findByDispNameDeep:e=>t.push([m(e),!1]),findByDispNameDeepAll:e=>t.push([m(e),!0]),findByKeyword:(...e)=>t.push([f(e),!1]),findByKeywordAll:(...e)=>t.push([f(e),!0])}),U=t=>e=>{let r=[],s=ce(r);return e(s),de(t,r)};var $=(t,e=!0)=>r=>{let s=[];for(let a in t){let n=t[a].exports;if(!(!n||n===window)){if(n.default&&n.__esModule&&r(n.default)){if(e)return n.default;s.push(n.default)}if(r(n)){if(e)return n;s.push(n)}}}if(!e)return s},P=([,t,e])=>{let r=$(t),s=$(t,!1),a=e?R(t,e.m):()=>{throw new Error("findByCode does not work with this bundler")};return{batchFind:U(t),find:r,findAll:s,findByProps:(...n)=>r(d(n)),findByPropsAll:(...n)=>s(d(n)),findByPrototypes:(...n)=>r(c(n)),findByPrototypesAll:(...n)=>s(c(n)),findByNestedProps:(...n)=>r(y(n)),findByNestedPropsAll:(...n)=>s(y(n)),findByDisplayName:(n,p)=>r(u(n,p)),findByDisplayNameAll:(n,p)=>s(u(n,p)),findByDispNameDeep:n=>r(m(n)),findByDispNameDeepAll:n=>s(m(n)),findByKeyword:(...n)=>r(f(n)),findByKeywordAll:(...n)=>s(f(n)),findByCodeAll:a,findByCode:n=>a(n)[0]}};var j=x(),K=j&&P([void 0,...j]),z=K&&K.findByProps("getAssetImage"),H=t=>z.fetchAssetIds?z.fetchAssetIds(h,[t,void 0]).then(e=>e[0]):void 0;var G=N(g()),E=N(g()),o=N(g()),J=N(g());var ue=(0,G.template)('<div style="display: flex"></div>',2),{store:i}=shelter.plugin,{TextBox:I,SwitchItem:Y,Header:B,HeaderTags:S,Divider:fe,Text:me,LinkButton:ye,Space:M,Button:be,ButtonColors:q,ButtonLooks:he,ButtonSizes:ge}=shelter.ui,W=t=>(0,o.createComponent)(be,{grow:!0,onClick:()=>i.service=t.service,get color(){return i.service===t.service?q.BRAND:q.SECONDARY},get look(){return he.OUTLINED},get size(){return ge.TINY},get children(){return t.children}}),we=()=>[(0,o.createComponent)(B,{get tag(){return S.H3},children:"Application Name"}),(0,o.createComponent)(I,{placeholder:D,get value(){return i.appName??""},onInput:t=>i.appName=t}),(0,o.createComponent)(B,{get tag(){return S.H3},children:"Service"}),(()=>{let t=ue.cloneNode(!0);return(0,E.insert)(t,(0,o.createComponent)(W,{service:"lfm",children:"Last.fm"}),null),(0,E.insert)(t,(0,o.createComponent)(W,{service:"lbz",children:"Listenbrainz"}),null),t})(),(0,o.createComponent)(B,{get tag(){return S.H3},get children(){return[(0,J.memo)(()=>i.service==="lbz"?"Listenbrainz":"Last.fm")," username (required)"]}}),(0,o.createComponent)(I,{get value(){return i.user??""},onInput:t=>i.user=t}),(0,o.createComponent)(B,{get tag(){return S.H3},children:"Update interval (seconds)"}),(0,o.createComponent)(I,{placeholder:5e3/1e3+"",get value(){return i.interval?i.interval/1e3+"":""},onInput:t=>(!t||!isNaN(parseFloat(t)))&&(i.interval=t?parseFloat(t)*1e3||5e3:void 0)}),(0,o.createComponent)(fe,{mt:!0,mb:!0}),(0,o.createComponent)(Y,{get value(){return i.stamp},onChange:t=>i.stamp=t,note:"Show time since song started playing",children:"Show time elapsed"}),(0,o.createComponent)(Y,{get value(){return i.ignoreSpotify},onChange:t=>i.ignoreSpotify=t,note:"Hide the status if Spotify is playing",children:"Hide when using Spotify"}),(0,o.createComponent)(me,{get children(){return["Thanks to",(0,o.createComponent)(ye,{href:"https://github.com/amsyarasyiq/letup/blob/main/plugins/Last.fm",get children(){return[(0,o.createComponent)(M,{}),"Pylix's Vendetta plugin",(0,o.createComponent)(M,{})]}}),"for useful implementation details and reference."]}})];var{plugin:{store:l},flux:{storesFlat:Q,dispatcher:Ae}}=shelter;l.stamp??=!0;l.ignoreSpotify??=!0;l.service??="lfm";var Ne=Q.UserStore,De=Q.PresenceStore,w=async(t="",e)=>Ae.dispatch({type:"LOCAL_ACTIVITY_UPDATE",activity:e?{name:t,type:2,details:e.name,state:e.artist,application_id:h,timestamps:l.stamp?{start:~~(Date.now()/1e3)}:void 0,assets:{large_image:e.albumArt&&await H(e.albumArt),large_text:e.album}}:null,socketId:"Last.fm@shelter"}),xe=async()=>{let t=new URLSearchParams({method:"user.getrecenttracks",user:l.user,api_key:v,format:"json",limit:"1",extended:"1"}),e=await fetch(`https://ws.audioscrobbler.com/2.0/?${t}`);if(!e.ok)return;let r=(await e.json())?.recenttracks?.track?.[0];if(!r)return;let s=r.image[3]["#text"];return{name:r.name,artist:r.artist.name,album:r.album["#text"],albumArt:L.includes(s)?void 0:s,url:r.url,nowPlaying:!!r["@attr"]?.nowplaying}},Pe=async()=>{let t=await fetch(`https://shcors.uwu.network/https://api.listenbrainz.org/1/user/${l.user}/playing-now`,{headers:{"X-Shprox-UA":"ShelterLastFm/0.0.0 ( https://github.com/yellowsink/shelter-plugins )"}}).then(s=>s.json());if(!t.payload.count)return;let e=t.payload.listens[0].track_metadata,r=e.additional_info?.release_mbid?`https://coverartarchive.org/release/${e.additional_info.release_mbid}/front`:void 0;return r&&((await fetch(r)).redirected||(r=void 0)),{name:e.track_name,artist:e.artist_name,album:e.release_name,albumArt:r,url:e.additional_info?.recording_mbid?`https://musicbrainz.org/recording/${e.additional_info.recording_mbid}`:`NOURL_${e.track_name}:${e.artist_name}:${e.release_name}`,nowPlaying:t.payload.listens[0].playing_now}},X,Be=async()=>{if(!l.user)return w();if(l.ignoreSpotify){for(let t of De.getActivities(Ne.getCurrentUser().id))if(t?.type===2&&t.application_id!==h)return w()}let getFn=l.service==="lbz"?Pe:xe,lastTrack=await getFn();if(!lastTrack?.nowPlaying)return w();if(lastTrack.url===X)return;X=lastTrack.url;let appName=l.appName||D;appName=appName.replaceAll(/{{(.+)}}/g,(_,code)=>eval(`(c)=>{with(c){try{return ${code}}catch(e){return e}}}`)(lastTrack)),await w(appName,lastTrack)},T,Se=()=>(T&&clearInterval(T),T=setInterval(Be,l.interval||5e3));Se();var ke=()=>(clearInterval(T),w());return ae(Te);})();
