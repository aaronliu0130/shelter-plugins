(()=>{var Z=Object.create;var A=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var te=Object.getOwnPropertyNames;var re=Object.getPrototypeOf,ne=Object.prototype.hasOwnProperty;var oe=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),se=(t,e)=>{for(var r in e)A(t,r,{get:e[r],enumerable:!0})},L=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of te(e))!ne.call(t,i)&&i!==r&&A(t,i,{get:()=>e[i],enumerable:!(o=ee(e,i))||o.enumerable});return t};var N=(t,e,r)=>(r=t!=null?Z(re(t)):{},L(e||!t||!t.__esModule?A(r,"default",{value:t,enumerable:!0}):r,t)),ae=t=>L(A({},"__esModule",{value:!0}),t);var g=oe((ot,V)=>{V.exports=shelter.solidWeb});var ve={};se(ve,{onUnload:()=>Te,settings:()=>_e});var D="{{name}}";var b="1107251687984472144",C="311958e99f6ee58518756f83720db787";var R=["2a96cbd8b46e442fc41c2b86b821562f","c6f59c1e5e7240a4c0d427abd71f3dbb"];var x=t=>{if(t??=Object.keys(window).find(r=>r.startsWith("webpackChunk")),!window[t])return;let e;return window[t].push([[Symbol()],{},r=>{e=r}]),window[t].pop(),[e.c??Object.fromEntries(Object.entries(e.m).map(([r])=>[r,{id:r,loaded:!0,exports:e(r)}])),e]};var c=t=>e=>t.every(r=>e[r]!==void 0),d=t=>e=>e.prototype&&t.every(r=>e.prototype[r]!==void 0),u=(t,e=!0)=>r=>(e?r.displayName:r.default?.displayName)===t,f=t=>e=>t.every(r=>Object.keys(e).some(o=>o.toLowerCase().includes(r.toLowerCase()))),m=t=>e=>{let r=new RegExp(`(${t}$)|((\\w+\\()+${t}\\))`);if(r.test(e.displayName))return!0;if(typeof e.$$typeof=="symbol"&&e.Consumer===void 0&&(e.type||e.render)){for(;typeof e.type=="object"||typeof e.render=="object";)e=e.type??e.render;if(r.test(e.type?.displayName)||r.test(e.render?.displayName))return!0}},F=t=>typeof t=="object"||typeof t=="function",y=t=>e=>F(e)&&Object.values(e).some(r=>F(r)&&t.some(o=>r?.[o]!==void 0)),U=(t,e)=>r=>Object.entries(e).filter(([,o])=>o.toString().match(r)).map(([o])=>t[o]?.exports).filter(o=>o);var ce=(t,e)=>{let r=[],o=i=>e.forEach(([n,p],h)=>{p&&!r[h]&&(r[h]=[]),n(i)&&(p?r[h].push(i):r[h]||(r[h]=i))});for(let i in t){let n=t[i].exports;!n||n===window||(n.default&&n.__esModule&&o(n.default),o(n))}return r},de=t=>({find:e=>t.push([e,!1]),findAll:e=>t.push([e,!0]),findByProps:(...e)=>t.push([c(e),!1]),findByPropsAll:(...e)=>t.push([c(e),!0]),findByPrototypes:(...e)=>t.push([d(e),!1]),findByPrototypesAll:(...e)=>t.push([d(e),!0]),findByNestedProps:(...e)=>t.push([y(e),!1]),findByNestedPropsAll:(...e)=>t.push([y(e),!0]),findByDisplayName:(e,r)=>t.push([u(e,r),!1]),findByDisplayNameAll:(e,r)=>t.push([u(e,r),!0]),findByDispNameDeep:e=>t.push([m(e),!1]),findByDispNameDeepAll:e=>t.push([m(e),!0]),findByKeyword:(...e)=>t.push([f(e),!1]),findByKeywordAll:(...e)=>t.push([f(e),!0])}),$=t=>e=>{let r=[],o=de(r);return e(o),ce(t,r)};var j=(t,e=!0)=>r=>{let o=[];for(let i in t){let n=t[i].exports;if(!(!n||n===window)){if(n.default&&n.__esModule&&r(n.default)){if(e)return n.default;o.push(n.default)}if(r(n)){if(e)return n;o.push(n)}}}if(!e)return o},P=([,t,e])=>{let r=j(t),o=j(t,!1),i=e?U(t,e.m):()=>{throw new Error("findByCode does not work with this bundler")};return{batchFind:$(t),find:r,findAll:o,findByProps:(...n)=>r(c(n)),findByPropsAll:(...n)=>o(c(n)),findByPrototypes:(...n)=>r(d(n)),findByPrototypesAll:(...n)=>o(d(n)),findByNestedProps:(...n)=>r(y(n)),findByNestedPropsAll:(...n)=>o(y(n)),findByDisplayName:(n,p)=>r(u(n,p)),findByDisplayNameAll:(n,p)=>o(u(n,p)),findByDispNameDeep:n=>r(m(n)),findByDispNameDeepAll:n=>o(m(n)),findByKeyword:(...n)=>r(f(n)),findByKeywordAll:(...n)=>o(f(n)),findByCodeAll:i,findByCode:n=>i(n)[0]}};var z=x(),K=z&&P([void 0,...z]),M=K&&K.findByProps("getAssetImage"),H=t=>M.fetchAssetIds?M.fetchAssetIds(b,[t,void 0]).then(e=>e[0]):void 0;var G=N(g()),E=N(g()),s=N(g()),J=N(g());var ue=(0,G.template)('<div style="display: flex"></div>',2),{store:a}=shelter.plugin,{TextBox:T,SwitchItem:v,Header:S,HeaderTags:k,Divider:fe,Text:me,LinkButton:ye,Space:Y,Button:he,ButtonColors:q,ButtonLooks:be,ButtonSizes:ge}=shelter.ui,{Show:we}=shelter.solid,W=t=>(0,s.createComponent)(he,{grow:!0,onClick:()=>a.service=t.service,get color(){return a.service===t.service?q.BRAND:q.SECONDARY},get look(){return be.OUTLINED},get size(){return ge.TINY},get children(){return t.children}}),_e=()=>[(0,s.createComponent)(S,{get tag(){return k.H3},children:"Application Name"}),(0,s.createComponent)(T,{placeholder:D,get value(){return a.appName??""},onInput:t=>a.appName=t}),(0,s.createComponent)(S,{get tag(){return k.H3},children:"Service"}),(()=>{let t=ue.cloneNode(!0);return(0,E.insert)(t,(0,s.createComponent)(W,{service:"lfm",children:"Last.fm"}),null),(0,E.insert)(t,(0,s.createComponent)(W,{service:"lbz",children:"Listenbrainz"}),null),t})(),(0,s.createComponent)(S,{get tag(){return k.H3},get children(){return[(0,J.memo)(()=>a.service==="lbz"?"Listenbrainz":"Last.fm")," username (required)"]}}),(0,s.createComponent)(T,{get value(){return a.user??""},onInput:t=>a.user=t}),(0,s.createComponent)(we,{get when(){return a.service==="lbz"},get children(){return(0,s.createComponent)(v,{get value(){return a.lbLookup},onChange:t=>a.lbLookup=t,note:"Depending on the scrobbler, Listenbrainz may not be able to return a release ID with the current track. If this happens, we can't fetch an album cover. This option will search musicbrainz for a matching release if this happens, to attempt to find a (hopefully correct) cover. If you get incorrect album art, turn this off. If you get missing album art, turn this on.",children:"Search Musicbrainz for missing releases"})}}),(0,s.createComponent)(S,{get tag(){return k.H3},children:"Update interval (seconds)"}),(0,s.createComponent)(T,{placeholder:5e3/1e3+"",get value(){return a.interval?a.interval/1e3+"":""},onInput:t=>(!t||!isNaN(parseFloat(t)))&&(a.interval=t?parseFloat(t)*1e3||5e3:void 0)}),(0,s.createComponent)(fe,{mt:!0,mb:!0}),(0,s.createComponent)(v,{get value(){return a.stamp},onChange:t=>a.stamp=t,note:"Show time since song started playing",children:"Show time elapsed"}),(0,s.createComponent)(v,{get value(){return a.ignoreSpotify},onChange:t=>a.ignoreSpotify=t,note:"Hide the status if Spotify is playing",children:"Hide when using Spotify"}),(0,s.createComponent)(me,{get children(){return["Thanks to",(0,s.createComponent)(ye,{href:"https://github.com/amsyarasyiq/letup/blob/main/plugins/Last.fm",get children(){return[(0,s.createComponent)(Y,{}),"Pylix's Vendetta plugin",(0,s.createComponent)(Y,{})]}}),"for useful implementation details and reference."]}})];var{plugin:{store:l},flux:{storesFlat:Q,dispatcher:Ne}}=shelter;l.stamp??=!0;l.ignoreSpotify??=!0;l.service??="lfm";l.lbLookup??=!0;var De=Q.UserStore,xe=Q.PresenceStore,w=async(t="",e)=>Ne.dispatch({type:"LOCAL_ACTIVITY_UPDATE",activity:e?{name:t,type:2,details:e.name,state:e.artist,application_id:b,timestamps:l.stamp?{start:~~(Date.now()/1e3)}:void 0,assets:{large_image:e.albumArt&&await H(e.albumArt),large_text:e.album}}:null,socketId:"Last.fm@shelter"}),Pe=async()=>{let t=new URLSearchParams({method:"user.getrecenttracks",user:l.user,api_key:C,format:"json",limit:"1",extended:"1"}),e=await fetch(`https://ws.audioscrobbler.com/2.0/?${t}`);if(!e.ok)return;let r=(await e.json())?.recenttracks?.track?.[0];if(!r)return;let o=r.image[3]["#text"];return{name:r.name,artist:r.artist.name,album:r.album["#text"],albumArt:R.includes(o)?void 0:o,url:r.url,nowPlaying:!!r["@attr"]?.nowplaying}},Se=async t=>{if(l.lbLookup&&!t.additional_info?.release_mbid)try{let e=await fetch(`https://shcors.uwu.network/https://api.listenbrainz.org/1/metadata/lookup/?${new URLSearchParams({recording_name:t.track_name,artist_name:t.artist_name,metadata:"true",inc:"artist tag release"})}`,{headers:{"X-Shprox-UA":"ShelterLastFm/0.0.0 ( https://github.com/yellowsink/shelter-plugins )"}}).then(r=>r.json());t.additional_info={...t?.additional_info,...e}}catch(e){console.error("SHELTER LASTFM: finding listenbrainz MBID for track",t,"failed, ",e)}},ke=async()=>{let t=await fetch(`https://shcors.uwu.network/https://api.listenbrainz.org/1/user/${l.user}/playing-now`,{headers:{"X-Shprox-UA":"ShelterLastFm/0.0.0 ( https://github.com/yellowsink/shelter-plugins )"}}).then(o=>o.json());if(!t.payload.count)return;let e=t.payload.listens[0].track_metadata;await Se(e);let r=e.additional_info?.release_mbid?`https://coverartarchive.org/release/${e.additional_info.release_mbid}/front`:void 0;return r&&((await fetch(r)).redirected||(r=void 0)),{name:e.track_name,artist:e.artist_name,album:e.release_name,albumArt:r,url:e.additional_info?.recording_mbid?`https://musicbrainz.org/recording/${e.additional_info.recording_mbid}`:`NOURL_${e.track_name}:${e.artist_name}:${e.release_name}`,nowPlaying:t.payload.listens[0].playing_now}},X,Be=async()=>{if(!l.user)return w();if(l.ignoreSpotify){for(let t of xe.getActivities(De.getCurrentUser().id))if(t?.type===2&&t.application_id!==b)return w()}let getFn=l.service==="lbz"?ke:Pe,lastTrack=await getFn();if(!lastTrack?.nowPlaying)return w();if(lastTrack.url===X)return;X=lastTrack.url;let appName=l.appName||D;appName=appName.replaceAll(/{{(.+)}}/g,(_,code)=>eval(`(c)=>{with(c){try{return ${code}}catch(e){return e}}}`)(lastTrack)),await w(appName,lastTrack)},I,Ie=()=>(I&&clearInterval(I),I=setInterval(Be,l.interval||5e3));Ie();var Te=()=>(clearInterval(I),w());return ae(ve);})();
